<?xml version="1.0" encoding="utf-8"?>

<root>

<!-- 패밀리 프로시저 실행 -->
<query name="/executeFamilyProcedure">
{ CALL SP_FAMILY({@WORK_ID}, {@REF_ID}) }
</query>

<!-- 패밀리 메인 목록 조회 -->
<query name="/retrieveFamilyMainList">
SELECT A.REF_ID KEY_VALUE
     , (CASE WHEN EXISTS(SELECT 1 FROM TB_APP_EXT_GRP WHERE GRP_ID = A.REF_ID) THEN FN_GRP_NO(A.REF_ID)
             ELSE FN_REF_NO(A.REF_ID)
       END) CAPTION
     , B.ABD_DATE
     , B.REG_DATE
     , B.APP_DATE
     , A.REF_TYPE SECTION_TYPE
     , B.KO_APP_TITLE BIGO
     , A.REF_TYPE TABID
     , B.INOUT_DIV
     , NULL GRP_NO
FROM   TB_FAMILY_ENTITY A
     , TB_APP_MST B
WHERE  A.REF_ID = B.REF_ID
AND    B.INOUT_DIV = 'INT'
AND    A.WORK_ID = {@WORK_ID}
UNION
SELECT A.REF_ID KEY_VALUE
     , (CASE WHEN EXISTS(SELECT 1 FROM TB_APP_EXT_GRP WHERE GRP_ID = A.REF_ID) THEN FN_GRP_NO(A.REF_ID)
             ELSE FN_REF_NO(A.REF_ID)
       END) CAPTION
     , NULL
     , NULL
     , NULL
     , A.REF_TYPE SECTION_TYPE
     , B.KO_APP_TITLE BIGO
     , A.REF_TYPE TABID
     , 'EXT' INOUT_DIV
     , B.GRP_NO
FROM   TB_FAMILY_ENTITY A
     , TB_APP_EXT_GRP B
WHERE  A.REF_ID  = B.GRP_ID
AND    A.WORK_ID = {@WORK_ID}
UNION
SELECT A.REF_ID KEY_VALUE
     , (CASE WHEN EXISTS(SELECT 1 FROM TB_APP_EXT_GRP WHERE GRP_ID = A.REF_ID) THEN FN_GRP_NO(A.REF_ID)
             ELSE FN_REF_NO(A.REF_ID)
       END) CAPTION
     , B.ABD_DATE
     , B.REG_DATE
     , B.APP_DATE
     , A.REF_TYPE SECTION_TYPE
     , B.KO_APP_TITLE BIGO
     , A.REF_TYPE TABID
     , B.INOUT_DIV
     , D.GRP_NO
FROM   TB_FAMILY_ENTITY A
     , TB_APP_MST B
     , TB_APP_MST_EXT C
     , TB_APP_EXT_GRP D
WHERE  A.REF_ID = B.REF_ID
AND    B.REF_ID = C.REF_ID
AND    C.GRP_ID = D.GRP_ID(+)
AND    A.WORK_ID = {@WORK_ID}
</query>

<!-- 패밀리 링크 목록 조회 -->
<query name="/retrieveFamilyLinkList">
SELECT ' ' CAPTION
     , NVL(MAX(A.PREV_REF_ID), ' ') SOUR
     , NVL(MAX(A.NEXT_REF_ID), ' ') DEST
     , NVL(MAX(A.RELATION), ' ') RELATION
     , ' ' BIGO
FROM   TB_FAMILY_LINK A
WHERE  A.WORK_ID = {@WORK_ID}
AND    (PREV_REF_ID IN (SELECT REF_ID FROM TB_FAMILY_ENTITY WHERE WORK_ID = {@WORK_ID}) OR
        NEXT_REF_ID IN (SELECT REF_ID FROM TB_FAMILY_ENTITY WHERE WORK_ID = {@WORK_ID})
       )
AND    A.NEXT_REF_ID IS NOT NULL
GROUP BY A.WORK_ID, A.PREV_REF_ID, A.NEXT_REF_ID
</query>

<!-- 패밀리 툴팁 상세정보 조회 -->
<query name="/retrieveFamilyTooltip">
SELECT A.REF_NO AS INFO_NO
     , FN_COM_CODE_NAME('INOUT_DIV', A.INOUT_DIV, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) INOUT_DIV_NAME
     , A.KO_APP_TITLE
     , FN_COUNTRY_NAME(A.COUNTRY_CODE) COUNTRY_NAME
     , A.APP_NO
     , A.APP_DATE
     , A.REG_NO
     , A.REG_DATE
     , FN_USER_NAME(A.JOB_MAN) JOB_MAN_NAME
     , FN_OFFICE_NAME(A.OFFICE_CODE) OFFICE_NAME
     , A.OFFICE_REF_NO
     , FN_USER_NAME(A.OFFICE_JOB_MAN) OFFICE_JOB_MAN_NAME
     , A.INOUT_DIV
FROM   TB_APP_MST A
WHERE  A.INOUT_DIV = 'INT'
AND    A.REF_ID = {@REF_ID}
UNION
SELECT C.GRP_NO AS INFO_NO
     , FN_COM_CODE_NAME('INOUT_DIV', A.INOUT_DIV, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) INOUT_DIV_NAME
     , A.KO_APP_TITLE
     , FN_COUNTRY_NAME(A.COUNTRY_CODE) COUNTRY_NAME
     , A.APP_NO
     , A.APP_DATE
     , A.REG_NO
     , A.REG_DATE
     , FN_USER_NAME(A.JOB_MAN) JOB_MAN_NAME
     , FN_OFFICE_NAME(A.OFFICE_CODE) OFFICE_NAME
     , A.OFFICE_REF_NO
     , FN_USER_NAME(A.OFFICE_JOB_MAN) OFFICE_JOB_MAN_NAME
     , A.INOUT_DIV
FROM   TB_APP_MST A
     , TB_APP_MST_EXT B
     , TB_APP_EXT_GRP C
WHERE  A.REF_ID = B.REF_ID
AND    B.GRP_ID = C.GRP_ID
AND    A.REF_ID = {@REF_ID}
UNION
SELECT C.GRP_NO AS INFO_NO
     , FN_COM_CODE_NAME('INOUT_DIV', A.INOUT_DIV, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) INOUT_DIV_NAME
     , A.KO_APP_TITLE
     , FN_COUNTRY_NAME(A.COUNTRY_CODE) COUNTRY_NAME
     , A.APP_NO
     , A.APP_DATE
     , A.REG_NO
     , A.REG_DATE
     , FN_USER_NAME(A.JOB_MAN) JOB_MAN_NAME
     , FN_OFFICE_NAME(A.OFFICE_CODE) OFFICE_NAME
     , A.OFFICE_REF_NO
     , FN_USER_NAME(A.OFFICE_JOB_MAN) OFFICE_JOB_MAN_NAME
     , A.INOUT_DIV
FROM   TB_APP_MST A
     , TB_APP_MST_EXT B
     , TB_APP_EXT_GRP C
WHERE  A.REF_ID = B.REF_ID
AND    B.GRP_ID = C.GRP_ID
AND    C.GRP_ID = {@REF_ID}
</query>

<!-- 패밀리 Flow 목록 조회 -->
<query name="/retrieveFamilyFlowList">
SELECT A.REF_ID
     , FN_PAPER_NAME(A.PAPER_CODE) PAPER_NAME
     , A.PAPER_DATE
FROM   TB_PAPER_LIST A
WHERE  A.REF_ID = {@REF_ID}
ORDER BY A.PAPER_DATE, A.LIST_SEQ
</query>

</root>
