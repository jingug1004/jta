<?xml version="1.0" encoding="utf-8"?>

<root>

<!-- 업무현황 건수 조회 -->
<query name="/retrieveBizFlowCount"><![CDATA[
SELECT W1.WF_ID
     , NVL(W2.WF_CNT, 0) WF_CNT
FROM   TB_PAPER_MGT_WF W1
     , (
SELECT WF_ID, COUNT(1) WF_CNT FROM (
{#baseQuery}
) W
GROUP BY WF_ID
) W2
WHERE  W1.WF_ID = W2.WF_ID(+)
]]></query>

<!-- 업무현황 목록 조회 -->
<query name="/retrieveBizFlowList"><![CDATA[
SELECT * FROM (
{#baseQuery}
)
WHERE  WF_ID = {@BIZ_FLOW_ID}
]]></query>


<!-- 업무현황 기본 쿼리문 -->
<query name="/retrieveBizFlowBase"><![CDATA[
SELECT 'APP_INT10' WF_ID
     , A.REF_ID
     , A.REF_NO
     , A.RIGHT_DIV
     , FN_COM_CODE_NAME('RIGHT_DIV', A.RIGHT_DIV, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) RIGHT_DIV_NAME
     , A.KO_APP_TITLE
     , NULL JOB_MAN
     , FN_BIZ_CODE_NAME(Z.STATUS, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) STATUS_NAME
     , NULL EXAM_RESULT
     , NULL PERIOD_EXTEND_CNT
     , NULL DUE_DATE
FROM   (SELECT T1.*
             , {@$USER_ID} JOB_MAN
        FROM   TB_APP_INT_REQ T1
       ) A
     , TB_BIZ_COM_MST Z
WHERE  A.REF_ID = Z.REF_ID
AND    Z.STATUS IN (SELECT T.CURR_STATUS
                    FROM   TB_BIZ_MGT_PROC T
                    WHERE  T.BIZ_STEP_ID IN ('WP_P01_100', 'WP_D01_100', 'WP_T01_100')
                    AND    T.BIZ_ACT = 'A00006'
                   )
{#commonWhere}
UNION ALL
SELECT 'APP_INT20' WF_ID
     , A.REF_ID
     , A.REF_NO
     , A.RIGHT_DIV
     , FN_COM_CODE_NAME('RIGHT_DIV', A.RIGHT_DIV, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) RIGHT_DIV_NAME
     , A.KO_APP_TITLE
     , A.JOB_MAN
     , FN_BIZ_CODE_NAME(Z.STATUS, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) STATUS_NAME
     , A.EXAM_RESULT
     , NULL PERIOD_EXTEND_CNT
     , NULL DUE_DATE
FROM   (SELECT T1.*
             , T2.JOB_MAN
        FROM   TB_APP_INT_CONSULT T1
             , TB_APP_MST T2
        WHERE  T1.REF_ID = T2.REF_ID
       ) A
     , TB_BIZ_COM_MST Z
WHERE  A.REF_ID = Z.REF_ID
AND    Z.STATUS IN (SELECT T.CURR_STATUS
                    FROM   TB_BIZ_MGT_PROC T
                    WHERE  T.BIZ_STEP_ID IN ('WP_P01_300', 'WP_D01_300', 'WP_T01_300')
                    AND    T.ACT_OWNER = 'PAT'
                   )
{#commonWhere}
UNION ALL
SELECT 'APP_INT30' WF_ID
     , A.REF_ID
     , A.REF_NO
     , A.RIGHT_DIV
     , FN_COM_CODE_NAME('RIGHT_DIV', A.RIGHT_DIV, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) RIGHT_DIV_NAME
     , A.KO_APP_TITLE
     , A.JOB_MAN
     , FN_PAPER_NAME(A.STATUS) AS STATUS_NAME
     , (SELECT EXAM_RESULT FROM TB_APP_INT_CONSULT T WHERE T.REF_ID = A.REF_ID) EXAM_RESULT
     , NULL PERIOD_EXTEND_CNT
     , NULL DUE_DATE
FROM   TB_APP_MST A
WHERE  A.INOUT_DIV = 'INT'
AND    A.ABD_YN = '0'
AND    A.OFFICE_SEND_DATE IS NOT NULL
AND    A.OFFICE_RCPT_DATE IS NULL
{#commonWhere}
UNION ALL
SELECT 'APP_INT70' WF_ID
     , A.REF_ID
     , A.REF_NO
     , A.RIGHT_DIV
     , FN_COM_CODE_NAME('RIGHT_DIV', A.RIGHT_DIV, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) RIGHT_DIV_NAME
     , A.KO_APP_TITLE
     , A.JOB_MAN
     , FN_PAPER_NAME(A.STATUS) AS STATUS_NAME
     , (SELECT EXAM_RESULT FROM TB_APP_INT_CONSULT T WHERE T.REF_ID = A.REF_ID) EXAM_RESULT
     , NULL PERIOD_EXTEND_CNT
     , NULL DUE_DATE
FROM   TB_APP_MST A
WHERE  A.INOUT_DIV = 'INT'
AND    A.ABD_YN = '0'
AND    A.APP_NO IS NOT NULL
AND    A.REG_NO IS NULL
{#commonWhere}
UNION ALL
SELECT 'APP_EXT10' WF_ID
     , A.REF_ID
     , A.REF_NO
     , A.RIGHT_DIV
     , FN_COM_CODE_NAME('RIGHT_DIV', A.RIGHT_DIV, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) RIGHT_DIV_NAME
     , A.KO_APP_TITLE
     , A.JOB_MAN
     , FN_COM_CODE_NAME('EXT_APP_STATUS', B.EXT_APP_STATUS, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) STATUS_NAME
     , NULL EXAM_RESULT
     , NULL PERIOD_EXTEND_CNT
     , NULL DUE_DATE
FROM   TB_APP_MST A
     , TB_APP_MST_INT B
WHERE  A.REF_ID = B.REF_ID(+)
AND    A.APP_NO IS NOT NULL
AND    B.EXT_APP_STATUS = '0'
AND    A.ABD_YN = '0'
AND    A.RIGHT_DIV IN ('10', '20')
AND    TO_CHAR(ADD_MONTHS(A.APP_DATE, 12), 'YYYYMMDD') >= TO_CHAR(SYSDATE, 'YYYYMMDD')
{#commonWhere}
UNION ALL
SELECT 'APP_EXT20' WF_ID
     , B.OL_ID
     , A.GRP_NO
     , A.RIGHT_DIV
     , FN_COM_CODE_NAME('RIGHT_DIV', A.RIGHT_DIV, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) RIGHT_DIV_NAME
     , A.KO_APP_TITLE
     , A.JOB_MAN
     , FN_BIZ_CODE_NAME(Z.STATUS, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) STATUS_NAME
     , NULL EXAM_RESULT
     , NULL PERIOD_EXTEND_CNT
     , NULL DUE_DATE
FROM   (SELECT T.GRP_ID REF_ID
             , T.*
        FROM   TB_APP_EXT_GRP T
       ) A
     , TB_APP_EXT_OL B
     , (SELECT MST.APPR_NO
             , MST.APPR_STATUS
             , ANS.ANS_STATUS
        FROM   TB_APPR_MST MST
             , TB_APPR_ANS ANS
        WHERE  MST.APPR_NO = ANS.APPR_NO
        AND    ANS.ANS_STATUS = '1'
        AND    ANS.REQ_SEQ IN (SELECT MAX(REQ_SEQ)
                               FROM   TB_APPR_ANS
                               WHERE  APPR_NO = MST.APPR_NO
                              )
       ) C
     , TB_BIZ_COM_MST Z
WHERE  A.GRP_ID = B.GRP_ID
AND    B.APPR_NO = C.APPR_NO
AND    B.OL_ID = Z.REF_ID
{#commonWhere}
UNION ALL
SELECT 'APP_EXT30' WF_ID
     , A.REF_ID
     , A.REF_NO
     , C.RIGHT_DIV
     , FN_COM_CODE_NAME('RIGHT_DIV', C.RIGHT_DIV, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) RIGHT_DIV_NAME
     , C.KO_APP_TITLE
     , A.JOB_MAN
     , FN_PAPER_NAME(A.STATUS) AS STATUS_NAME
     , NULL EXAM_RESULT
     , NULL PERIOD_EXTEND_CNT
     , NULL DUE_DATE
FROM   TB_APP_MST A
     , TB_APP_MST_EXT B
     , TB_APP_EXT_GRP C
     , TB_APP_EXT_OL D
     , (SELECT MST.APPR_NO
             , MST.APPR_STATUS
             , ANS.ANS_STATUS
        FROM   TB_APPR_MST MST
             , TB_APPR_ANS ANS
        WHERE  MST.APPR_NO = ANS.APPR_NO
        AND    ANS.ANS_STATUS = '8'
        AND    ANS.REQ_SEQ IN (SELECT MAX(REQ_SEQ)
                              FROM   TB_APPR_ANS
                              WHERE  APPR_NO = MST.APPR_NO)
        ) E
WHERE  A.REF_ID = B.REF_ID
AND    B.GRP_ID = C.GRP_ID
AND    C.GRP_ID = D.GRP_ID
AND    D.APPR_NO = E.APPR_NO
AND    A.STATUS  = 'S00008'
{#commonWhere}
UNION ALL
SELECT 'APP_EXT70' WF_ID
     , A.REF_ID
     , A.REF_NO
     , A.RIGHT_DIV
     , FN_COM_CODE_NAME('RIGHT_DIV', A.RIGHT_DIV, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) RIGHT_DIV_NAME
     , A.KO_APP_TITLE
     , A.JOB_MAN
     , FN_PAPER_NAME(A.STATUS) AS STATUS_NAME
     , NULL EXAM_RESULT
     , NULL PERIOD_EXTEND_CNT
     , NULL DUE_DATE
FROM   TB_APP_MST A
WHERE  A.INOUT_DIV = 'EXT'
AND    A.ABD_YN = '0'
AND    A.APP_NO IS NOT NULL
AND    A.REG_NO IS NULL
{#commonWhere}
UNION ALL
SELECT D.WF_ID
     , A.REF_ID
     , A.REF_NO
     , A.RIGHT_DIV
     , FN_COM_CODE_NAME('RIGHT_DIV', A.RIGHT_DIV, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) RIGHT_DIV_NAME
     , A.KO_APP_TITLE
     , A.JOB_MAN
     , FN_PAPER_NAME(A.STATUS) STATUS_NAME
     , (SELECT EXAM_RESULT FROM TB_APP_INT_CONSULT T WHERE T.REF_ID = A.REF_ID) EXAM_RESULT
     , NULL PERIOD_EXTEND_CNT
     , NULL DUE_DATE
FROM   TB_APP_MST A
     , (SELECT T1.*
        FROM   TB_PAPER_LIST T1
             , (SELECT REF_ID, MAX(LIST_SEQ) LIST_SEQ
                FROM   TB_PAPER_LIST
                WHERE  (PAPER_CODE, PAPER_SUBCODE) IN (SELECT PAPER_CODE, PAPER_SUBCODE FROM TB_PAPER_MGT_WF_LIST)
                GROUP BY REF_ID
               ) T2
        WHERE  T1.REF_ID = T2.REF_ID
        AND    T1.LIST_SEQ = T2.LIST_SEQ
       ) B
     , TB_PAPER_MGT_WF_LIST C
     , TB_PAPER_MGT_WF D
WHERE  A.REF_ID = B.REF_ID
AND    B.PAPER_CODE = C.PAPER_CODE
AND    B.PAPER_SUBCODE = C.PAPER_SUBCODE
AND    C.WF_CODE = D.WF_CODE
AND    D.WF_KIND = 'APP'
AND    D.WF_ID IN ('APP_INT40', 'APP_INT50', 'APP_INT60', 'APP_EXT40', 'APP_EXT50', 'APP_EXT60')
AND    A.ABD_YN = '0'
AND    A.REG_NO IS NULL
AND    A.APP_NO IS NULL
{#commonWhere}
UNION ALL
SELECT D.WF_ID
     , A.REF_ID
     , A.REF_NO
     , A.RIGHT_DIV
     , FN_COM_CODE_NAME('RIGHT_DIV', A.RIGHT_DIV, {@$LANG_CODE}, {@$DEFAULT_LANG_CODE}) RIGHT_DIV_NAME
     , A.KO_APP_TITLE
     , A.JOB_MAN
     , FN_PAPER_NAME(A.STATUS) AS STATUS_NAME
     , (SELECT EXAM_RESULT FROM TB_APP_INT_CONSULT T WHERE T.REF_ID = A.REF_ID) EXAM_RESULT
     , FN_OA_PERIOD_EXTEND_CNT(Z.REF_ID, Z.OA_SEQ) PERIOD_EXTEND_CNT
     , (SELECT DUE_DATE FROM TB_OA_HIST T WHERE T.REF_ID = A.REF_ID AND T.OA_SEQ = Z.OA_SEQ) DUE_DATE
FROM   TB_APP_MST A
     , (SELECT T1.*
        FROM   TB_PAPER_LIST T1
             , (SELECT REF_ID, MAX(LIST_SEQ) LIST_SEQ
                FROM   TB_PAPER_LIST
                WHERE  (PAPER_CODE, PAPER_SUBCODE) IN (SELECT PAPER_CODE, PAPER_SUBCODE FROM TB_PAPER_MGT_WF_LIST)
                GROUP BY REF_ID
               ) T2
        WHERE  T1.REF_ID = T2.REF_ID
        AND    T1.LIST_SEQ = T2.LIST_SEQ
       ) B
     , TB_PAPER_MGT_WF_LIST C
     , TB_PAPER_MGT_WF D
     , TB_OA_HIST Z
WHERE  A.REF_ID = B.REF_ID
AND    B.PAPER_CODE = C.PAPER_CODE
AND    B.PAPER_SUBCODE = C.PAPER_SUBCODE
AND    C.WF_CODE = D.WF_CODE
AND    D.WF_KIND = 'OA'
AND    A.ABD_YN = '0'
AND    A.REG_NO IS NULL
AND    Z.REF_ID = A.REF_ID
AND    Z.END_YN = '0'
{#commonWhere}
]]></query>

<!-- 업무현황 건담당자 조건 공통 -->
<query name="/retrieveBizFlowBase/jobMan"><![CDATA[
AND    A.JOB_MAN = {@$USER_ID}
]]></query>

<!-- 업무현황 발명자 조건 공통 -->
<query name="/retrieveBizFlowBase/invUser"><![CDATA[
AND    A.REF_ID IN (SELECT T.REF_ID FROM TB_MAPP_INVENTOR T WHERE T.INV_USER = {@$USER_ID})
]]></query>

</root>
